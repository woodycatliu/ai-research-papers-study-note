# LEANN: 一種低儲存向量索引的閱讀報告

這篇論文《**LEANN**: 一種低儲存向量索引》聚焦於解決在資源受限的個人設備上部署嵌入式搜尋（embedding-based search）所面臨的巨大儲存開銷問題。隨著人工智慧的發展，嵌入式搜尋在推薦系統、檢索增強生成（**RAG**）等應用中越來越普遍，但其所需的索引資料結構往往非常龐大，使得在本地設備上部署變得不切實際。LEANN 的目標是大幅減少這種儲存負擔，同時保持高搜尋品質和低延遲。

## 論文重點

### 問題陳述：高儲存開銷的挑戰

* 傳統的**近似最近鄰（ANN）**資料結構會引入大量的儲存開銷，通常是原始資料大小的 1.5 到 7 倍。例如，索引 100 GB 的原始資料可能需要 150 到 700 GB 的儲存空間，這對於個人筆記型電腦或手機等邊緣設備來說是不可行的。
* 現有的解決方案，如**產品量化（PQ）**等壓縮技術，雖然能減少儲存，但往往會犧牲搜尋準確性，或需要增加搜尋延遲才能達到可比的結果。大多數 ANN 索引設計時假設所有資料（包括全精度嵌入）都能放入記憶體，這使其不適用於記憶體受限的消費設備。

### LEANN 的核心洞見

* **見解一：圖形搜尋中的即時重計算**
    * 在基於圖形的索引（如 HNSW）中，單次查詢通常只會探索一小部分嵌入向量來識別其最近鄰居。因此，LEANN 的核心思想是**不將這些嵌入向量儲存在磁碟上，而是在搜尋時即時重新計算它們**。這避免了儲存龐大嵌入向量所帶來的儲存負擔。
* **見解二：高連結度保留的圖形剪枝**
    * 即使不儲存嵌入向量，索引的**中繼資料**（例如圖結構）本身仍可能導致相當大的儲存開銷。LEANN 觀察到圖形索引中的許多中繼資料是冗餘的，並非所有節點和邊都對搜尋準確性有同等貢獻。因此，LEANN 引入了一種**高連結度（high-degree）保留的圖形剪枝策略**，它會移除低效用的邊，同時保留對維持有效搜尋路徑至關重要的**高連結度「中心」節點（hub nodes）**。

## LEANN 的主要技術

### 高效圖形重計算（Efficient Graph-based Recomputation）

* **兩階段搜尋與混合距離（Two-Level Search with Hybrid Distance）**：為了降低即時重計算的延遲，LEANN 採用多重精度的距離計算框架。它使用**輕量級的近似計算**（如基於 PQ 的方法）來初步評估候選節點，而**精確計算只應用於最有希望的候選節點**。這減少了需要重新計算嵌入的節點數量，從而降低了整體延遲。
* **動態批次處理（Dynamic Batching）**：在搜尋過程中，GPU 資源可能因為每次擴展只觸發少量節點的重計算而未被充分利用。LEANN 通過**動態收集一組最接近的候選節點，直到達到目標批次大小**，從而打破了最佳優先搜尋中嚴格的資料依賴性。這顯著增加了嵌入模型處理的批次大小，提高了 GPU 利用率並減少了端到端延遲。

### 儲存優化的圖結構（Storage-optimized Graph Structure）

* **高連結度保留的圖形剪枝算法（High Degree Preserving Graph Pruning Algorithm）**：此算法在圖形構建過程中引入差異化的連結度閾值。對於大多數節點，連結數減少到較低的閾值 *m*，而一小部分（例如，論文中提到前 2%）的重要高連結度節點被允許保留更高的連結數（最高可達閾值 *M*）。這種方法在顯著減少圖形儲存開銷的同時，保持了搜尋性能，因為它保留了在搜尋過程中頻繁訪問的「中心」節點。

## LEANN 的主要貢獻與成果

* **儲存效率：** LEANN 將索引大小減少到**原始資料的 5% 以下**，比標準索引小 50 倍。
* **搜尋性能：** 在真實世界的問答基準測試中，LEANN 能夠在 **2 秒內**保持 **90% 的 Top-3 召回率**。它在 A10 和 M1 Mac 平台上的延遲表現具有競爭力。
* **下游任務準確性：** 在 RAG 任務中，LEANN 始終比基於關鍵字的 BM25 和 PQ 壓縮的向量搜尋方法**實現更高的下游準確性**。
* **技術開創性：** 這是第一項旨在實現低延遲、高準確性、且在邊緣設備上以最小儲存開銷進行個人資料搜尋的研究。
* **優化效果：** 兩階段搜尋平均提速 1.40 倍，動態批次處理進一步將整體提速提高到 1.76 倍。其圖形剪枝方法在只使用一半邊緣的情況下，性能仍可與原始未剪枝圖形相媲美。

---

## 值得注意的論點

### 對邊緣設備的影響

* 論文明確指出，LEANN 的設計是為了解決在個人設備（如智慧家居設備、筆記型電腦和手機）上部署向量索引的**嚴格儲存限制**問題。這使得在設備上實現個性化搜尋、離線助手和保護隱私的檢索成為可能。
* 雖然存在一些延遲犧牲，但對於這些設備上的大規模文件檢索或離線語義召回等使用者任務，**秒級延遲**（即在 10 秒以下）通常是可以接受的。許多下游任務（如圖像或文本生成）本身就需要數十秒才能完成，因此 LEANN 引入的額外延遲是合理的。

### 與現有方法的比較

* LEANN **顯著優於 EdgeRAG**（一種基於 IVF 的重計算方法），延遲降低了 21.17 到 200.60 倍，部分原因在於重計算複雜度的漸近差異。
* 與 DiskANN 相比，LEANN 的**動態批次處理策略**專注於最大化 GPU 利用率，而不是像 DiskANN 那樣主要減少磁碟 I/O 遲延。
* 論文批評了 PQ 壓縮等**現有壓縮技術的局限性**，即它們通常在嚴格的儲存預算下難以保持高搜尋準確性，導致資訊損失。LEANN 通過結合精確計算和高連結度保留的剪枝來彌補這一點。

### 剪枝策略的有效性

* 論文透過圖形節點連結度分佈的分析（圖 8）證明，LEANN 的剪枝方法**成功保留了大量的高連結度「中心」節點**，而其他兩種啟發式基準方法（隨機剪枝和限制最大連結數）則未能做到。這強調了高連結度節點在支持高效圖形化向量搜尋中的關鍵作用。
* 這種剪枝方法**不需要關於查詢分佈的知識**，因此可以有效地擴展到大型資料集。

### 潛在的限制與未來發展

* **當前限制：** LEANN 在搜尋時儲存開銷很低，但在**索引構建階段，由於需要預先計算所有通道的嵌入以構建圖形，因此峰值儲存使用量可能很高**。論文提出了一種潛在的解決方案，即預先對資料進行分簇，然後在每個簇內獨立構建圖形，並在構建完成後丟棄嵌入。
* **未來工作：**
    * 預計隨著消費級 GPU 的進步和更緊湊、高效嵌入模型的發展，LEANN 的延遲開銷將會降低。
    * 未來的優化方向包括**重疊 I/O、CPU 和 GPU 資源**，以進一步提高整體效率。
    * LEANN 的解決方案在**資料中心環境**中也有廣泛的適用性，因為在這些環境中，高維向量的儲存管理也面臨巨大挑戰。

---

總體而言，LEANN 提出了一種創新且實用的方法，使高階語義搜尋能夠首次在受限的邊緣設備上得以實現，為未來的邊緣 AI 應用開闢了新的可能性。